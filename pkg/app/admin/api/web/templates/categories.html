{{ define "title"}} Categories {{end}} {{ define "content"}}

<style>
  #msg {
    margin-bottom: 1rem;
  }

  #form-container {
    display: none;
    margin-top: 1rem;
    border: 1px solid #1f2937;
    padding: 1rem;
    border-radius: 8px;
  }

  table#categories {
    margin-top: 1rem;
    border-collapse: collapse;
    width: 100%;
  }

  table#categories th,
  table#categories td {
    border: 1px solid #1f2937;

    padding: 8px;
  }

  table#categories th {
    background: #f4f4f4;
    text-align: left;
  }

  table#categories tr:nth-child(even) {
    background: #f9f9f9;
  }

  table#categories tr:hover {
    background: #f1f1f1;
  }

  button {
    margin: 2px;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  button:hover {
    opacity: 0.9;
  }

  button[onclick^="showAddForm"] {
    background-color: #2563eb;
    color: white;
  }

  button[onclick^="editCategory"] {
    background-color: #f59e0b;
    color: white;
  }

  button[onclick^="deleteCategory"] {
    background-color: #dc2626;
    color: white;
  }
</style>

<div id="msg"></div>

<button onclick="showAddForm()">‚ûï Add Category</button>

<div id="form-container">
  <h3 id="form-title">Add Category</h3>
  <form id="category-form">
    <input type="hidden" id="cat-id" />
    <label>Name: <input type="text" id="cat-name" required /></label
    ><br /><br />
    <label>Description: <input type="text" id="cat-desc" /></label><br /><br />
    <button type="submit">Save</button>
    <button type="button" onclick="hideForm()">Cancel</button>
  </form>
</div>

<table id="categories">
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
      <th>Created At</th>
      <th>Updated At</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const API = `${API_BASE}/v1/categories`;

  async function loadCategories() {
    const msg = document.getElementById("msg");
    msg.textContent = "Loading...";
    msg.style.color = "black";

    try {
      const res = await fetch(API);
      if (!res.ok) throw new Error("error getting categories");
      const data = await res.json();

      const tbody = document.querySelector("#categories tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No categories found</td></tr>`;
        msg.textContent = "";
        return;
      }

      data.forEach((cat) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${cat.name}</td>
          <td>${cat.desc || ""}</td>
          <td>${cat.created_at}</td>
          <td>${cat.updated_at}</td>
          <td>
            <button onclick="editCategory('${cat.id}', '${cat.name}', '${
          cat.desc || ""
        }')">‚úèÔ∏è Update</button>
            <button onclick="deleteCategory('${cat.id}')">üóëÔ∏è Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      msg.textContent = "";
    } catch (err) {
      msg.textContent = err.message;
      msg.style.color = "red";
    }
  }

  function showAddForm() {
    document.getElementById("form-title").textContent = "Add Category";
    document.getElementById("cat-id").value = "";
    document.getElementById("cat-name").value = "";
    document.getElementById("cat-desc").value = "";
    document.getElementById("form-container").style.display = "block";
  }

  function editCategory(id, name, desc) {
    document.getElementById("form-title").textContent = "Update Category";
    document.getElementById("cat-id").value = id;
    document.getElementById("cat-name").value = name;
    document.getElementById("cat-desc").value = desc;
    document.getElementById("form-container").style.display = "block";
  }

  function hideForm() {
    document.getElementById("form-container").style.display = "none";
  }

  document
    .getElementById("category-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("cat-id").value;
      const name = document.getElementById("cat-name").value;
      const desc = document.getElementById("cat-desc").value;

      try {
        let res;
        if (id) {
          // Update
          res = await fetch(`${API}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, desc }),
          });
        } else {
          // Add
          res = await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, desc }),
          });
        }

        if (!res.ok) throw new Error("error to save category");

        hideForm();
        loadCategories();
      } catch (err) {
        alert(err.message);
      }
    });

  async function deleteCategory(id) {
    if (!confirm("Are you sure you want to delete this category?")) return;
    try {
      const res = await fetch(`${API}/${id}`, { method: "DELETE" });
      if (!res.ok) throw new Error("Error deleting category");
      loadCategories();
    } catch (err) {
      alert(err.message);
    }
  }

  loadCategories();
</script>
{{ end }}
